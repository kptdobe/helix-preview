<html>

<head>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/editor/0.1.0/editor.css">
    <link rel="stylesheet" href="/editor.css">
    <script src="//cdn.jsdelivr.net/editor/0.1.0/editor.js"></script>
    <script src="//cdn.jsdelivr.net/editor/0.1.0/marked.js"></script>
</head>

<body>
    <div class="container">
        <div class="authoring box">
            <div class="preview-toggle-container"><button id="preview-toggle">&nbsp;</button></div>
            <textarea id="md" style="margin: 0px; width: 500px; height: 100%">
# Model 3

## Tesla

![Model 3](/content/images/banner1.jpg)

If you haven't test driven the car, you can return it within 3 days of delivery.

* From 0-60 mph: 3.3s
* Range: 310 mi
* Dual Motor: AWD
* [Order Now](https://3.tesla.com/model3/design)

---

# Dual Motor

## All-Wheel Drive

![Model 3](/content/images/banner2.jpg)

* Independent motors digitally control torque to the front and rear wheels: 2
* Dual motors respond to changing conditions in as little as 10 milliseconds: 10 ms
* Unparalleled traction and control, in all weather conditions: ![Model 3](/content/images/sun-cloud.png)

Tesla All-Wheel Drive has two independent motors. Unlike traditional all-wheel drive systems, these two motors
digitally control torque to the front and rear wheelsâ€”for far better handling and traction control. Your car can drive
on either motor, so you never need to worry about getting stuck on the road. If one motor stops working, you can safely
continue to your destination with the second.

[Order Now](https://3.tesla.com/model3/design)</textarea>
        </div>
        <div class="preview box">
            <iframe id="frame"></iframe>
        </div>
    </div>
    <script src="/diffDOM.js"></script>
    <script>
        const editor = new Editor();
        const dd = new diffDOM.DiffDOM();

        function preview(first) {
            const url =
                "https://adobeioruntime.net/api/v1/web/acapt/eabbfb4a4d6d13dbdcb388e92769b4fb6302931d-dirty/html";

            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    const frame = document.getElementById("frame");
                    const newDOM = xhttp.responseText;
                    if (first) {
                        frame.contentDocument.documentElement.innerHTML  = newDOM;
                    } else {
                        const outDiv = frame.contentDocument.body;
                        const newElement = frame.contentDocument.createElement('body');
                        newElement.innerHTML = newDOM.substring(newDOM.indexOf('<body>')+6, newDOM.indexOf('</body>'));
                        dd.apply(outDiv, dd.diff(outDiv, newElement));
                    }
                }
            };
            //const md = document.getElementById("md").value;
            const md = editor.codemirror.getValue();

            xhttp.open("POST", url);
            xhttp.setRequestHeader('X-Debug', 'silly');
            xhttp.setRequestHeader('Content-Type', 'application/json');
            xhttp.send(JSON.stringify({
                content: {
                    body: md
                }
            }));
        }
    </script>
    <script src="https://togetherjs.com/togetherjs-min.js"></script>
    <script>
        let timeout;
        window.addEventListener('load', function () {
            editor.render();

            editor.codemirror.on('change', function () {
                if (!timeout) {
                    timeout = window.setTimeout(function () {
                        preview();
                        timeout = null;
                    }, 500);
                }
            });

            editor.codemirror.on('cursorActivity', function(doc) {
                try {
                    TogetherJS.send({type: "cursorActivity", cursor: doc.getCursor()});
                } catch(e) {}
            });

            const TogetherJSConfig_autoStart = true;

            TogetherJS.config("disableWebRTC", true);
            TogetherJS.config("suppressJoinConfirmation", true);
            TogetherJS.config("dontShowClicks", true);
            TogetherJS.config("suppressInvite", true);

            TogetherJS(this);

            TogetherJS.config('findRoom', 'authoring_helix_demo_xyz');

            const getCursor = function(id) {
                const css = 'remote-cursor-' + id;

                const existing = document.getElementsByClassName(css);
                if (existing.length > 0) {
                    existing[0].remove();
                }

                const tpcss = 'togetherjs-person-' + id;
                const tpElement = document.getElementsByClassName(tpcss);

                let color = 'black';
                let title = ''
                if (tpElement.length > 0) {
                    color = tpElement[0].style['border-color'];
                    title = tpElement[0].title;
                }

                const div = document.createElement('div');
                div.className = 'remote-cursor ' + css;
                const cursor = document.createElement('div');
                cursor.innerHTML = ' ';
                cursor.style['border-color'] = color;
                const titleDiv = document.createElement('div');
                titleDiv.innerHTML = title;
                titleDiv.style['background-color'] = color;
                div.appendChild(titleDiv);
                div.appendChild(cursor);
                return div;
            }

            TogetherJS.hub.on('cursorActivity', function (msg) {
                console.log('###### cursorActivity msg received!!', msg);
                editor.codemirror.addWidget(msg.cursor, getCursor(msg.clientId.replace(/\./g,'_')), false);
            });

            preview(true);  
        }, false);
    </script>
    <script>
        document.getElementById("preview-toggle").addEventListener("click", (ev) => {
            console.log("preview toggle clicked");
            // todo: toggle preview pane
            ev.cancelBubble = true;
        });
    </script>
</body>

</html>
